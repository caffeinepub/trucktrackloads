{
  "kind": "build_request",
  "title": "Fix password-admin login so users can access /admin dashboard after logging in",
  "priority": "high",
  "requirements": [
    {
      "id": "REQ-1",
      "text": "Fix the password-based admin session flow so that after a successful `/admin/login`, navigating to `/admin` reliably renders the admin dashboard instead of redirecting back to `/admin/login` or showing an access-denied state.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "recent-messages"
        ],
        "quotes": [
          "I cannot access my admin after logging in"
        ]
      },
      "acceptanceCriteria": [
        "From a fresh session (no Internet Identity login), entering correct admin credentials on `/admin/login` redirects to `/admin` and the dashboard renders.",
        "After refreshing the page while on `/admin`, the user remains authorized for the duration of the browser session (until sessionStorage is cleared) and the dashboard still renders.",
        "If the admin token is cleared (logout/sign-out flow), attempting to access `/admin` redirects to `/admin/login`."
      ]
    },
    {
      "id": "REQ-2",
      "text": "Ensure that a password-admin session initializes backend authorization with the admin token even when the user is not authenticated via Internet Identity (i.e., when the app is using an anonymous identity), so that admin verification queries (e.g., `isCallerAdmin`) succeed immediately after login.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "recent-messages"
        ],
        "quotes": [
          "I cannot access my admin after logging in"
        ]
      },
      "acceptanceCriteria": [
        "When `sessionStorage.caffeineAdminToken` is present, admin verification uses an actor instance that has had `_initializeAccessControlWithSecret(caffeineAdminToken)` invoked, regardless of whether Internet Identity is logged in.",
        "Immediately after successful admin password login, the admin verification query refetches and resolves to authorized without requiring manual refresh.",
        "No changes are made to any frontend immutable paths listed in SYSTEM_CONTEXT (in particular, do not edit `frontend/src/hooks/useActor.ts`)."
      ]
    },
    {
      "id": "REQ-3",
      "text": "Update admin route guarding and admin login handling to remove timing/race dependencies (e.g., fixed `setTimeout` delays) and instead rely on explicit state transitions (token stored → admin verification refetched → navigation) so the experience is consistent across devices and network speeds.",
      "target": "frontend",
      "source": {
        "messageIds": [
          "recent-messages"
        ],
        "quotes": [
          "I cannot access my admin after logging in"
        ]
      },
      "acceptanceCriteria": [
        "Admin login does not rely on arbitrary delays to succeed; it waits on concrete verification/refetch completion before considering the session valid.",
        "If admin verification fails after login, the UI shows a clear error state (in English) with a working Retry action that re-attempts verification.",
        "The `/admin` route never gets stuck in an infinite redirect loop between `/admin` and `/admin/login`."
      ]
    },
    {
      "id": "REQ-4",
      "text": "Verify and, if needed, fix backend admin verification so that the token returned by `adminLogin(username, password)` results in `isCallerAdmin()` returning `true` for the session after the frontend has initialized access control with `_initializeAccessControlWithSecret(token)`.",
      "target": "backend",
      "source": {
        "messageIds": [
          "recent-messages"
        ],
        "quotes": [
          "I cannot access my admin after logging in"
        ]
      },
      "acceptanceCriteria": [
        "With correct credentials, `adminLogin` returns a token and subsequent calls in the same session (after `_initializeAccessControlWithSecret(token)`) cause `isCallerAdmin()` to return `true` for that caller.",
        "With an invalid/empty token, `isCallerAdmin()` returns `false` (or traps with a clear unauthorized error), and admin-only methods remain protected.",
        "Admin-only backend methods (e.g., approving loads, verifying users, viewing contact messages) remain inaccessible without valid admin verification."
      ]
    }
  ],
  "constraints": [
    "Backend must remain a single Motoko actor in `backend/main.mo` (no additional backend services).",
    "Do not edit any frontend files under `frontend/src/hooks/useInternetIdentity.ts` / `.tsx`, `frontend/src/hooks/useActor.ts`, `frontend/src/main.tsx`, or anything in `frontend/src/components/ui` (compose instead).",
    "Use English for all user-facing text."
  ],
  "nonGoals": [
    "Adding new authentication providers (only existing Internet Identity + password-admin token flow).",
    "Implementing real-time features (WebSockets/push notifications).",
    "Changing admin credentials or adding a UI for rotating the hidden token beyond what already exists."
  ],
  "imageRequirements": {
    "required": [],
    "edits": []
  }
}